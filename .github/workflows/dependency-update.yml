name: Dependency Update

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Check for dependency updates
      run: ./gradlew dependencyUpdates

    - name: Upload dependency report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-updates-report
        path: build/dependencyUpdates/
        retention-days: 30

  gradle-wrapper-update:
    name: Update Gradle Wrapper
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Update Gradle Wrapper
      run: |
        # èŽ·å–æœ€æ–°çš„Gradleç‰ˆæœ¬
        LATEST_GRADLE=$(curl -s https://api.github.com/repos/gradle/gradle/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')
        echo "Latest Gradle version: $LATEST_GRADLE"
        
        # æ›´æ–°Gradle Wrapper
        ./gradlew wrapper --gradle-version=$LATEST_GRADLE

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Gradle wrapper'
        title: 'ðŸ”§ Update Gradle Wrapper'
        body: |
          ## ðŸ”§ Gradle Wrapper æ›´æ–°
          
          è¿™ä¸ªPRè‡ªåŠ¨æ›´æ–°äº†Gradle Wrapperåˆ°æœ€æ–°ç‰ˆæœ¬ã€‚
          
          ### ðŸ“‹ æ›´æ”¹å†…å®¹
          - æ›´æ–° `gradle/wrapper/gradle-wrapper.properties`
          - æ›´æ–° `gradle/wrapper/gradle-wrapper.jar`
          - æ›´æ–° `gradlew` å’Œ `gradlew.bat`
          
          ### âœ… æ£€æŸ¥æ¸…å•
          - [ ] æž„å»ºæˆåŠŸ
          - [ ] æµ‹è¯•é€šè¿‡
          - [ ] æ— ç ´åæ€§æ›´æ”¹
          
          ---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
        branch: chore/update-gradle-wrapper
        delete-branch: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run security audit
      run: |
        # æ£€æŸ¥å·²çŸ¥çš„å®‰å…¨æ¼æ´ž
        ./gradlew dependencyCheckAnalyze || true

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: build/reports/dependency-check-report.html
        retention-days: 30

  notify-updates:
    name: Notify Updates
    needs: [update-dependencies, gradle-wrapper-update, security-audit]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create issue for updates
      if: needs.update-dependencies.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ðŸ“¦ ä¾èµ–æ›´æ–°æŠ¥å‘Š - ' + new Date().toISOString().split('T')[0];
          const body = `## ðŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
          
          ### ðŸ“… æ£€æŸ¥æ—¶é—´
          ${new Date().toLocaleString()}
          
          ### ðŸ” æ£€æŸ¥ç»“æžœ
          - ä¾èµ–æ›´æ–°æ£€æŸ¥: ${{ needs.update-dependencies.result == 'success' && 'âœ… å®Œæˆ' || 'âŒ å¤±è´¥' }}
          - Gradleæ›´æ–°æ£€æŸ¥: ${{ needs.gradle-wrapper-update.result == 'success' && 'âœ… å®Œæˆ' || 'âŒ å¤±è´¥' }}
          - å®‰å…¨å®¡è®¡: ${{ needs.security-audit.result == 'success' && 'âœ… å®Œæˆ' || 'âŒ å¤±è´¥' }}
          
          ### ðŸ“‹ æ“ä½œå»ºè®®
          1. æŸ¥çœ‹ä¾èµ–æ›´æ–°æŠ¥å‘Šå·¥ä»¶
          2. æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨æ¼æ´žéœ€è¦ä¿®å¤
          3. è€ƒè™‘æ›´æ–°é‡è¦ä¾èµ–
          
          ### ðŸ”— ç›¸å…³é“¾æŽ¥
          - [ä¾èµ–æ›´æ–°æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [å®‰å…¨å®¡è®¡æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*`;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„issue
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies'
          });
          
          const existingIssue = issues.find(issue => 
            issue.title.includes('ä¾èµ–æ›´æ–°æŠ¥å‘Š') && 
            issue.created_at > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'maintenance']
            });
          }
